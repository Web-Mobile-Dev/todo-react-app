stages: 
    - build 
    - test
    - deploy_production
    - deploy_staging
    - publish_staging
    - publish_production

image: node:latest

variables:
  CI_STAGING_ID: "staging"
  CI_PRODUCTION_ID: "production"

cache: 
    paths: 
        - ToDoProject/build/

build:
    stage: build
    script: 
        - cd ToDoProject
        - npm i
        - npm run build
    artifacts:
        name: "todo-app"
        paths:
        - ToDoProject/build/*
    rules:
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
        
test: 
    stage: test
    dependencies: 
    - build
    script: 
        - cd ToDoProject
        - npm i
        - npm run test
    rules:
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
        
deploy_production:
    stage: deploy_production
    environment: production
    dependencies: 
    - build
    image: python:latest
    script:
    - pip install awscli
    - aws s3 cp ./ToDoProject/build/ s3://todo-react-app/ --recursive
    rules:
        - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
        
pages:
    stage: deploy_staging
    image: alpine:latest
    environment: staging
    dependencies: 
        - build
    script:
        - mkdir -p ./public
        - cp -r ./ToDoProject/build/. ./public/
    artifacts: 
        paths:
            - public
    rules:
        - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "staging"'

pages: 
    stage: publish_staging
    image: alpine:latest
    dependencies: 
        - build
    script:
        - mkdir -p ./public/$CI_STAGING_ID
        - cp -r ./ToDoProject/build/. ./public/$CI_STAGING_ID
    artifacts: 
        paths:
            - public

pages: 
    stage: publish_production
    image: alpine:latest
    dependencies: 
        - build
    script:
        - mkdir -p ./public/$CI_PRODUCTION_ID
        - cp -r ./ToDoProject/build/. ./public/$CI_PRODUCTION_ID
    artifacts: 
        paths:
            - public